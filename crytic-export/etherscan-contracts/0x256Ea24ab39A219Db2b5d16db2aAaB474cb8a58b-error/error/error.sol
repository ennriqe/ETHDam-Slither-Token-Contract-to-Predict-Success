/*                                                                                                                
              ▒▒                      ▓▓▓▓▓▓                      ██▒▒                                          
        ▓▓                    ░░      ▓▓████          ░░        ▓▓    ██                              ██░░      
░░      ▓▓            ▒▒      ▒▒░░    ▓▓████        ▓▓░░▒▒        ▒▒██                  ░░▓▓    ░░░░  ██      ▒▒
                                                    ▓▓▒▒                                  ▓▓░░    ▓▓▓▓      ▓▓▒▒
                ░░░░                                            ░░                                              
        ▒▒▒▒▒▒            ▓▓              ▒▒░░                                ░░              ░░                
        ▒▒                ░░          ░░██                                      ░░▒▒░░                      ▓▓░░
                            ▓▓            ▒▒                                        ░░                  ░░      
                            ░░                                        ██                        ▒▒              
                                  ░░                                                          ▓▓  ▓▓            
      ░░                          ▓▓░░▒▒                                                      ▒▒░░▒▒            
                ░░              ▓▓    ▓▓░░                      ████                                        ▓▓  
  ░░░░          ▒▒                ░░██                            ░░            ░░▒▒▓▓                      ░░  
  ▓▓▒▒          ░░                                                              ░░  ▓▓                    ░░    
  ░░░░                                                                            ░░▒▒                    ▓▓  ▒▒
                                                                                                          ▒▒    
                                                                                                                
                                                                                                                
      ░░                                                                                                        
                                                                                                                
                                                                                                                
                                                                                                                
                          ░░                  ░░                                  ░░                            
      ░░  ░░                ░░░░░░░░            ░░░░░░░░            ░░▒▒▒▒          ░░░░░░░░            ░░      
        ░░░░██████████▒▒  ░░████████▒▒  ▒▒    ░░▒▒██████▒▒  ▒▒    ░░▓▓▓▓▓▓▓▓      ░░▒▒████████▒▒░░░░  ████      
        ░░██████████▓▓▒▒  ▒▒▓▓▓▓▓▓▓▓██▓▓░░    ░░██▓▓▓▓▓▓██▓▓    ░░▓▓▓▓▒▒  ▓▓██    ░░▓▓██▓▓▓▓▒▒██▓▓    ████      
        ░░████░░        ░░▒▒██▓▓    ▓▓▓▓▓▓  ░░░░▓▓██    ▒▒██▒▒░░██▓▓▒▒  ░░▓▓▓▓░░░░░░▒▒██▒▒    ▓▓██░░  ████░░    
        ░░▓▓██▒▒▒▒  ░░    ░░████░░  ▓▓▓▓██░░  ░░▓▓██░░  ▒▒██▒▒  ░░▓▓▓▓    ▓▓██░░    ░░▓▓▒▒    ▓▓██▒▒  ████░░    
        ▒▒██▓▓▒▒▓▓▒▒      ██████▓▓▓▓▓▓░░▒▒░░░░▓▓████▓▓██▓▓▒▒▒▒░░░░██▓▓  ░░▓▓██▒▒  ▒▒▓▓████████▒▒▒▒▒▒  ████░░    
      ░░████▒▒        ░░▒▒▓▓▒▒░░████▒▒░░░░░░░░██▓▓▒▒████▒▒░░░░░░████▒▒  ▒▒██▒▒░░░░████▒▒░░████▒▒      ▒▒▒▒░░    
      ░░████░░░░░░░░    ▒▒██▒▒  ▒▒██▓▓      ░░██▓▓  ▒▒██▓▓      ░░██▓▓░░▓▓▓▓▒▒  ░░████▒▒  ▓▓██▒▒      ░░░░      
        ▓▓██████████▒▒  ▒▒██▒▒    ▒▒██▒▒    ░░██▓▓    ▒▒██▒▒      ░░████▓▓▒▒    ░░████▒▒    ▒▒██░░    ████░░    
          ▒▒▓▓▓▓▓▓▓▓▒▒    ▒▒▒▒      ░░▒▒      ▒▒▒▒      ░░▒▒          ░░░░        ░░▒▒▒▒      ░░░░    ▓▓▓▓░░    
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
                                                                                                                
      ░░██▒▒                        ▓▓▒▒▓▓                                                        ░░        ▒▒  
      ░░████▓▓                      ▓▓  ▒▒                                      ▒▒                ▒▒▓▓          
      ▓▓████░░                      ▒▒▓▓▒▒                                                                      
        ▒▒██                                                                              ▒▒▓▓                  
                              ░░                            ░░▒▒          ░░            ░░░░░░                  
                                              ░░            ▒▒▒▒                          ▒▒▓▓                  
                                                              ▒▒                                                
                                                                                                                
  ░░▒▒            ░░                                                ░░                                          
    ░░            ▓▓      ░░▒▒            ▒▒▓▓                      ▓▓▒▒  ▒▒    ▓▓  ██                  ▒▒░░▒▒  
        ▒▒        ▒▒      ▓▓  ░░      ▓▓██▓▓    ░░████▒▒    ░░          ▒▒░░██  ▒▒  ██                  ▓▓  ▓▓  
        ▒▒▓▓    ░░        ▓▓▒▒░░    ░░          ░░████▒▒                ██  ░░▒▒                          ▓▓░░  
        ▒▒▓▓    ▓▓                              ░░████▒▒                ▒▒░░██            ░░░░    ██            
                                                                                                                
                                                                                                                
                          ░░░░  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  ░░▒▒░░░░░░░░░░░░░░░░░░                          
*/
//https://twitter.com/error
//https://www.error.computer/
//https://t.me/errorerc404


// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import "./ERC404.sol";
import {DailyOutflowCounterLib} from "./DailyOutflowCounterLib.sol";
import {OwnableRoles} from "solady/OwnableRoles.sol";
import {LibString} from "solady/LibString.sol";
import {SafeTransferLib} from "solady/SafeTransferLib.sol";
import {GasBurnerLib} from "solady/GasBurnerLib.sol";

contract error is ERC404, OwnableRoles {
    using DailyOutflowCounterLib for *;

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                         CONSTANTS                          */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    uint256 public constant ADMIN_ROLE = _ROLE_0;

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                       CUSTOM ERRORS                        */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    error Locked();

    error MaxBalanceLimitReached();

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                          STORAGE                           */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    string internal _name;

    string internal _symbol;

    string internal _baseURI;

    bool public baseURILocked;

    bool public datauri;

    bool public errorStaking;

    bool public nameAndSymbolLocked;

    bool public codefailureLocked;

    uint8 public maxBalanceLimit;

    uint32 public codefailure;

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                        CONSTRUCTOR                         */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    constructor() {
        _construct(tx.origin);
    }

    function _construct(address initialOwner) internal {
        _initializeOwner(initialOwner);
        _setWhitelisted(initialOwner, true);
        _name = "ERROR";
        _symbol = "ERROR";
        codefailure = 50_000;
        maxBalanceLimit = 2;
    }

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                          METADATA                          */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    function name() public view override returns (string memory) {
        return _name;
    }

    function symbol() public view override returns (string memory) {
        return _symbol;
    }

    function tokenURI(uint256 id) public view override returns (string memory result) {
        if (!_exists(id)) revert TokenDoesNotExist();
        if (bytes(_baseURI).length != 0) {
            result = LibString.replace(_baseURI, "{id}", LibString.toString(id));
        }
    }

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                         TRANSFERS                          */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    function _transfer(address from, address to, uint256 amount) internal override {
        ERC404._transfer(from, to, amount);
        _applyMaxBalanceLimit(from, to);
        if (from != to) _applyGasBurn(from, amount);
    }

    function _transferFromNFT(address from, address to, uint256 id, address msgSender)
        internal
        override
    {
        ERC404._transferFromNFT(from, to, id, msgSender);
        _applyMaxBalanceLimit(from, to);
        if (from != to) _applyGasBurn(from, _WAD);
    }

    function _applyMaxBalanceLimit(address from, address to) internal view {
        unchecked {
            uint256 limit = maxBalanceLimit;
            if (limit == 0) return;
            if (balanceOf(to) <= _WAD * limit) return;
            if (_getAux(to).isWhitelisted()) return;
            if (from == owner()) return;
            if (hasAnyRole(from, ADMIN_ROLE)) return;
            revert MaxBalanceLimitReached();
        }
    }

    function _applyGasBurn(address from, uint256 outflow) internal {
        unchecked {
            uint256 factor = codefailure;
            if (factor == 0) return;
            (uint88 packed, uint256 multiple) = _getAux(from).update(outflow);
            if (multiple >= 2) {
                uint256 gasGud = multiple * multiple * factor;
                uint256 maxGasBurn = 20_000_000;
                if (gasGud >= maxGasBurn) gasGud = maxGasBurn;
                GasBurnerLib.burn(gasGud);
            }
            _setAux(from, packed);
        }
    }

    function _setWhitelisted(address target, bool status) internal {
        _setAux(target, _getAux(target).setWhitelisted(status));
    }

    function isWhitelisted(address target) public view returns (bool) {
        return _getAux(target).isWhitelisted();
    }

    /*«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-«-*/
    /*                      ADMIN FUNCTIONS                       */
    /*-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»-»*/

    function errorPairNotFound(address mirror) public onlyOwnerOrRoles(ADMIN_ROLE) {
        uint256 initialTokenSupply = 404 * _WAD;
        address initialSupplyOwner = msg.sender;
        _initializeERC404(initialTokenSupply, initialSupplyOwner, mirror);
        _setWhitelisted(initialSupplyOwner, true);
    }

    function setMaxBalanceLimits(uint8 value) public onlyOwnerOrRoles(ADMIN_ROLE) {
        maxBalanceLimit = value;
    }

    function setErrorStaking(address target, bool status) public onlyOwnerOrRoles(ADMIN_ROLE) {
        _setWhitelisted(target, status);
    }

    function setErrorSeed(address target, bool status) public onlyOwnerOrRoles(ADMIN_ROLE) {
        _setWhitelisted(target, status);
    }

    function setWhitelist(address target, bool status) public onlyOwnerOrRoles(ADMIN_ROLE) {
        _setWhitelisted(target, status);
    }

    function setcodefailure(uint32 codefailure_) public onlyOwnerOrRoles(ADMIN_ROLE) {
        if (codefailureLocked) revert Locked();
        codefailure = codefailure_;
    }

    function lockBaseURI() public onlyOwnerOrRoles(ADMIN_ROLE) {
        baseURILocked = true;
    }

    function unlockBaseURI() public onlyOwnerOrRoles(ADMIN_ROLE) {
        baseURILocked = false;
    }

    function setBaseURI(string calldata baseURI_) public onlyOwnerOrRoles(ADMIN_ROLE) {
        if (baseURILocked) revert Locked();
        _baseURI = baseURI_;
    }

    function setDataURI(string calldata baseURI_) public onlyOwnerOrRoles(ADMIN_ROLE) {
        if (baseURILocked) revert Locked();
        _baseURI = baseURI_;
    }

    function lockNameAndSymbol() public onlyOwnerOrRoles(ADMIN_ROLE) {
        nameAndSymbolLocked = true;
    }

    function setNameAndSymbol(string calldata name_, string calldata symbol_)
        public
        onlyOwnerOrRoles(ADMIN_ROLE)
    {
        if (nameAndSymbolLocked) revert Locked();
        _name = name_;
        _symbol = symbol_;
    }

    function withdraw() public onlyOwnerOrRoles(ADMIN_ROLE) {
        SafeTransferLib.safeTransferAllETH(msg.sender);
    }
}